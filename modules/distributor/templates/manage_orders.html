{% extends "distributor_base.html" %}

{% block title %}My Orders - Golden Bee{% endblock %}
{% block page_title %}My Orders{% endblock %}
{% block breadcrumb %}Orders / My Orders{% endblock %}

{% block extra_css %}
<style>
    /* Action Bar */
    .action-bar {
        background: white;
        padding: 20px;
        border-radius: 12px;
        border: 1px solid #E5E7EB;
        margin-bottom: 24px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        flex-wrap: wrap;
        gap: 16px;
    }

    .btn-new-order {
        background: linear-gradient(135deg, #FDB022, #FFD54F);
        color: #1F2937;
        padding: 12px 24px;
        border-radius: 8px;
        font-weight: 600;
        text-decoration: none;
        display: inline-flex;
        align-items: center;
        gap: 8px;
        transition: all 0.2s ease;
        border: none;
        box-shadow: 0 2px 8px rgba(253, 176, 34, 0.2);
    }

    .btn-new-order:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(253, 176, 34, 0.3);
        color: #1F2937;
    }

    /* Message Center Button */
    .message-center-btn {
        position: relative;
        width: 48px;
        height: 48px;
        border-radius: 10px;
        border: none;
        background: white;
        color: #3B82F6;
        cursor: pointer;
        transition: all 0.2s ease;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 20px;
    }

    .message-center-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
        background: #EFF6FF;
    }

    .message-badge {
        position: absolute;
        top: -6px;
        right: -6px;
        background: #EF4444;
        color: white;
        font-size: 11px;
        font-weight: 700;
        padding: 2px 6px;
        border-radius: 10px;
        min-width: 20px;
        text-align: center;
        box-shadow: 0 2px 8px rgba(239, 68, 68, 0.4);
        animation: pulse 2s infinite;
    }

    @keyframes pulse {
        0%, 100% { transform: scale(1); }
        50% { transform: scale(1.1); }
    }

    /* Filter Buttons */
    .filter-btn {
        padding: 10px 20px;
        border-radius: 8px;
        font-size: 14px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s ease;
        border: 2px solid #E5E7EB;
        background: white;
        color: #6B7280;
        display: inline-flex;
        align-items: center;
        gap: 8px;
    }

    .filter-btn:hover {
        border-color: #FDB022;
        color: #1F2937;
    }

    .filter-btn.active {
        background: linear-gradient(135deg, #FDB022, #FFD54F);
        color: #1F2937;
        border-color: #FDB022;
        box-shadow: 0 2px 8px rgba(253, 176, 34, 0.2);
    }

    /* Search Box */
    .search-box {
        position: relative;
    }

    .search-box i {
        position: absolute;
        left: 12px;
        top: 50%;
        transform: translateY(-50%);
        color: #6B7280;
        font-size: 14px;
    }

    .search-box input {
        width: 100%;
        padding: 10px 12px 10px 38px;
        border: 1px solid #E5E7EB;
        border-radius: 8px;
        font-size: 14px;
        font-family: inherit;
        transition: all 0.2s ease;
    }

    .search-box input:focus {
        outline: none;
        border-color: #FDB022;
        box-shadow: 0 0 0 3px rgba(253, 176, 34, 0.1);
    }

    .search-box input::placeholder {
        color: #9CA3AF;
    }

    /* Stats Cards */
    .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 20px;
        margin-bottom: 30px;
    }

    .stat-card {
        background: white;
        padding: 20px;
        border-radius: 12px;
        border: 1px solid #E5E7EB;
        text-align: center;
        transition: all 0.3s ease;
    }

    .stat-card:hover {
        transform: translateY(-4px);
        box-shadow: 0 8px 24px rgba(0,0,0,0.12);
    }

    .stat-value {
        font-size: 32px;
        font-weight: 700;
        margin-bottom: 8px;
    }

    .stat-value.primary { color: #3B82F6; }
    .stat-value.warning { color: #F59E0B; }
    .stat-value.success { color: #10B981; }
    .stat-value.danger { color: #EF4444; }

    .stat-label {
        font-size: 14px;
        color: #6B7280;
        font-weight: 500;
    }

    /* Table Container */
    .table-container {
        background: white;
        border-radius: 12px;
        overflow: hidden;
        box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }

    table {
        width: 100%;
        border-collapse: collapse;
    }

    thead {
        background: #F9FAFB;
    }

    th {
        padding: 14px 20px;
        text-align: left;
        font-size: 12px;
        font-weight: 600;
        color: #6B7280;
        text-transform: uppercase;
        letter-spacing: 0.05em;
    }

    tbody tr {
        border-bottom: 1px solid #F3F4F6;
        transition: background 0.2s;
    }

    tbody tr:hover {
        background: #F9FAFB;
    }

    td {
        padding: 16px 20px;
        font-size: 14px;
        color: #111827;
    }

    .order-id {
        font-weight: 700;
        color: #111827;
    }

    .products-cell {
        max-width: 250px;
        overflow: hidden;
        text-overflow: ellipsis;
    }

    .quantity-badge {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        padding: 6px 12px;
        background: #DBEAFE;
        border-radius: 6px;
        font-weight: 600;
        color: #1E40AF;
        font-size: 14px;
    }

    .status-badge {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        padding: 6px 14px;
        border-radius: 20px;
        font-size: 12px;
        font-weight: 600;
        text-transform: uppercase;
        min-width: 100px;
        justify-content: center;
    }

    .status-pending {
        background: #FEF3C7;
        color: #92400E;
        border: 1px solid #FCD34D;
    }

    .status-accepted {
        background: #D1FAE5;
        color: #065F46;
        border: 1px solid #6EE7B7;
    }

    .status-rejected {
        background: #FEE2E2;
        color: #991B1B;
        border: 1px solid #FCA5A5;
    }

    .status-requested { background: #FEF3C7; color: #92400E; }
    .status-confirmed { background: #DBEAFE; color: #1E40AF; }
    .status-shipped { background: #E0E7FF; color: #3730A3; }
    .status-delivered { background: #D1FAE5; color: #065F46; }
    .status-cancelled { background: #FEE2E2; color: #991B1B; }

    .total-amount {
        font-weight: 700;
        color: #10B981;
        font-size: 16px;
    }

    .action-buttons {
        display: flex;
        gap: 8px;
        flex-wrap: wrap;
    }

    .btn-action {
        padding: 6px 14px;
        border-radius: 6px;
        font-size: 13px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s ease;
        border: none;
        text-decoration: none;
        display: inline-flex;
        align-items: center;
        gap: 6px;
    }

    .btn-view {
        background: #E0E7FF;
        color: #3730A3;
    }

    .btn-view:hover {
        background: #6366F1;
        color: white;
    }

    .btn-message {
        background: #DBEAFE;
        color: #1E3A8A;
    }

    .btn-message:hover {
        background: #3B82F6;
        color: white;
    }

    .btn-edit {
        background: #FEF3C7;
        color: #92400E;
    }

    .btn-edit:hover {
        background: #F59E0B;
        color: white;
    }

    .btn-cancel {
        background: #FEE2E2;
        color: #991B1B;
    }

    .btn-cancel:hover {
        background: #EF4444;
        color: white;
    }

    /* Empty State */
    .empty-state {
        text-align: center;
        padding: 60px 20px;
    }

    .empty-icon {
        font-size: 64px;
        color: #D1D5DB;
        margin-bottom: 24px;
    }

    .empty-title {
        font-size: 24px;
        font-weight: 600;
        color: #374151;
        margin-bottom: 12px;
    }

    .empty-text {
        color: #6B7280;
        margin-bottom: 24px;
        font-size: 16px;
    }

    @media (max-width: 768px) {
        .stats-grid {
            grid-template-columns: 1fr 1fr;
        }

        .action-bar {
            flex-direction: column;
            align-items: stretch;
        }

        .btn-new-order {
            width: 100%;
            justify-content: center;
        }

        .filter-btn {
            flex: 1;
            min-width: 120px;
            justify-content: center;
        }

        .search-box {
            width: 100% !important;
        }

        .action-buttons {
            flex-direction: column;
        }

        .btn-action {
            width: 100%;
            justify-content: center;
        }
    }
</style>
{% endblock %}

{% block content %}
<!-- Action Bar -->
<div class="action-bar">
    <h2 style="margin: 0; font-size: 20px; font-weight: 600; color: #111827;">
        <i class="fas fa-shopping-cart"></i> Order Management
    </h2>
    <div style="display: flex; gap: 12px; align-items: center;">
        <!-- Message Center Icon -->
        <button class="message-center-btn" onclick="showAllMessages()" title="Message Center">
            <i class="fas fa-envelope"></i>
            <span class="message-badge" id="unreadBadge" style="display: none;">0</span>
        </button>
        
        <a href="{{ url_for('distributor_order_bp.add_order') }}" class="btn-new-order">
            <i class="fas fa-plus-circle"></i>
            Place New Order
        </a>
    </div>
</div>

<!-- Stats Cards -->
<div class="stats-grid">
    <div class="stat-card">
        <div class="stat-value primary">{{ orders|length if orders else 0 }}</div>
        <div class="stat-label">Total Orders</div>
    </div>
    <div class="stat-card">
        <div class="stat-value warning">
            {% if orders %}
                {{ orders|selectattr('status', 'equalto', 'pending')|list|length }}
            {% else %}
                0
            {% endif %}
        </div>
        <div class="stat-label">Pending</div>
    </div>
    <div class="stat-card">
        <div class="stat-value success">
            {% if orders %}
                {% set total_qty = orders|sum(attribute='total_quantity') %}
                {{ total_qty }}
            {% else %}
                0
            {% endif %}
        </div>
        <div class="stat-label">Total Quantity</div>
    </div>
    <div class="stat-card">
        <div class="stat-value danger">
            {% if orders %}
                {% set total_amount = orders|sum(attribute='total_amount') %}
                Rs. {{ "%.2f"|format(total_amount) }}
            {% else %}
                Rs. 0.00
            {% endif %}
        </div>
        <div class="stat-label">Total Amount</div>
    </div>
</div>

<!-- Orders Table -->
{% if orders %}

<!-- Filter Buttons and Search (moved below stats) -->
<div class="action-bar" style="padding: 16px 20px;">
    <div style="display: flex; gap: 10px; flex-wrap: wrap; width: 100%;">
        <button class="filter-btn active" onclick="filterOrders('all')">
            <i class="fas fa-list"></i>
            All Orders
        </button>
        <button class="filter-btn" onclick="filterOrders('pending')">
            <i class="fas fa-clock"></i>
            Pending
        </button>
        <button class="filter-btn" onclick="filterOrders('accepted')">
            <i class="fas fa-check-circle"></i>
            Accepted
        </button>
        <button class="filter-btn" onclick="filterOrders('rejected')">
            <i class="fas fa-times-circle"></i>
            Rejected
        </button>
    </div>
    <div class="search-box" style="width: 300px;">
        <i class="fas fa-search"></i>
        <input type="text" id="searchInput" placeholder="Search orders..." onkeyup="searchOrders()">
    </div>
</div>
<div class="table-container">
    <table>
        <thead>
            <tr>
                <th>Order ID</th>
                <th>Date</th>
                <th>Products</th>
                <th>Quantity</th>
                <th>Status</th>
                <th>Total Amount</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody>
            {% for order in orders %}
            <tr>
                <td>
                    <span class="order-id">#{{ order.order_id }}</span>
                </td>
                <td>
                    <span style="color: #6B7280;">
                        <i class="far fa-calendar-alt"></i>
                        {{ order.order_date.strftime('%d/%m/%Y %H:%M') }}
                    </span>
                </td>
                <td class="products-cell" title="{{ order.products }}">
                    {{ order.products|truncate(40) }}
                </td>
                <td>
                    <span class="quantity-badge">
                        <i class="fas fa-boxes"></i>
                        {{ order.total_quantity }}
                    </span>
                </td>
                <td>
                    <span class="status-badge status-{{ order.status }}">
                        <i class="fas fa-{% if order.status == 'requested' %}clock{% elif order.status == 'confirmed' %}check{% elif order.status == 'shipped' %}shipping-fast{% elif order.status == 'delivered' %}check-circle{% else %}times-circle{% endif %}"></i>
                        {{ order.status|upper }}
                    </span>
                </td>
                <td>
                    <span class="total-amount">Rs. {{ "%.2f"|format(order.total_amount) }}</span>
                </td>
                <td>
                    <div class="action-buttons">
                        <a href="{{ url_for('distributor_order_bp.order_details', order_id=order.order_id) }}" 
                           class="btn-action btn-view">
                            <i class="fas fa-eye"></i>
                            View
                        </a>
                        
                        <a href="#" class="btn-action btn-message"
                           data-order-id="{{ order.order_id }}"
                           data-order-info="{{ order.products|truncate(30) }}"
                           onclick="openMessageModal(this.dataset.orderId, this.dataset.orderInfo); return false;">
                            <i class="fas fa-comment"></i>
                            Message
                        </a>
                        
                        {% if order.status == 'requested' or order.status == 'pending' %}
                        <a href="{{ url_for('distributor_order_bp.update_order', order_id=order.order_id) }}" 
                           class="btn-action btn-edit">
                            <i class="fas fa-edit"></i>
                            Edit
                        </a>
                        
                        <form action="{{ url_for('distributor_order_bp.cancel_order', order_id=order.order_id) }}" 
                              method="POST" style="display: inline;">
                            <button type="submit" class="btn-action btn-cancel"
                                    onclick="return confirm('Are you sure you want to cancel order #{{ order.order_id }}?')">
                                <i class="fas fa-times"></i>
                                Cancel
                            </button>
                        </form>
                        {% endif %}
                    </div>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

{% else %}
<!-- Empty State -->
<div class="table-container">
    <div class="empty-state">
        <div class="empty-icon">
            <i class="fas fa-shopping-cart"></i>
        </div>
        <div class="empty-title">No Orders Yet</div>
        <div class="empty-text">
            You haven't placed any orders yet. Start by placing your first order!
        </div>
        <a href="{{ url_for('distributor_order_bp.add_order') }}" class="btn-new-order">
            <i class="fas fa-plus-circle"></i>
            Place Your First Order
        </a>
    </div>
</div>
{% endif %}

<!-- Message Modal -->
<div id="messageModal" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 9999; align-items: center; justify-content: center;">
    <div style="background: white; border-radius: 12px; padding: 30px; max-width: 500px; width: 90%; box-shadow: 0 20px 60px rgba(0,0,0,0.3);">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
            <h3 style="margin: 0; font-size: 20px; font-weight: 600; color: #111827;">
                <i class="fas fa-comment"></i> Send Message
            </h3>
            <button onclick="closeMessageModal()" style="background: none; border: none; font-size: 24px; color: #6B7280; cursor: pointer;">
                <i class="fas fa-times"></i>
            </button>
        </div>
        
        <div style="margin-bottom: 20px; padding: 12px; background: #F3F4F6; border-radius: 8px;">
            <div style="font-size: 12px; color: #6B7280; margin-bottom: 4px;">Order:</div>
            <div style="font-weight: 600; color: #111827;" id="modalOrderInfo"></div>
        </div>
        
        <form id="messageForm" style="display: flex; flex-direction: column; gap: 16px;">
            <input type="hidden" id="messageOrderId" name="order_id">
            
            <div>
                <label style="display: block; font-size: 14px; font-weight: 600; color: #374151; margin-bottom: 8px;">
                    Your Message
                </label>
                <textarea id="messageText" name="message" rows="5" required
                          style="width: 100%; padding: 12px; border: 1px solid #E5E7EB; border-radius: 8px; font-family: inherit; font-size: 14px; resize: vertical;"
                          placeholder="Type your message to admin..."></textarea>
            </div>
            
            <div style="display: flex; gap: 10px; justify-content: flex-end;">
                <button type="button" onclick="closeMessageModal()" 
                        style="padding: 10px 20px; border-radius: 8px; font-weight: 600; cursor: pointer; border: 2px solid #E5E7EB; background: white; color: #6B7280;">
                    Cancel
                </button>
                <button type="submit"
                        style="padding: 10px 20px; border-radius: 8px; font-weight: 600; cursor: pointer; border: none; background: linear-gradient(135deg, #FDB022, #FFD54F); color: #1F2937;">
                    <i class="fas fa-paper-plane"></i> Send Message
                </button>
            </div>
        </form>
    </div>
</div>

<script>
// Message Modal Functions
function openMessageModal(orderId, orderInfo) {
    document.getElementById('messageOrderId').value = orderId;
    document.getElementById('modalOrderInfo').textContent = '#' + orderId + ' - ' + orderInfo;
    document.getElementById('messageModal').style.display = 'flex';
    document.getElementById('messageText').value = '';
    document.getElementById('messageText').focus();
}

function closeMessageModal() {
    document.getElementById('messageModal').style.display = 'none';
}

// Handle message form submission
document.getElementById('messageForm').addEventListener('submit', function(e) {
    e.preventDefault();
    
    const orderId = document.getElementById('messageOrderId').value;
    const message = document.getElementById('messageText').value;
    
    // Here you would send the message to your backend
    // For now, we'll just show a success message
    alert('Message sent for Order #' + orderId + ':\n\n' + message);
    closeMessageModal();
    
    // TODO: Implement actual backend API call
    // fetch('/distributor/send_message', {
    //     method: 'POST',
    //     headers: { 'Content-Type': 'application/json' },
    //     body: JSON.stringify({ order_id: orderId, message: message })
    // });
});

// Close modal when clicking outside
document.getElementById('messageModal').addEventListener('click', function(e) {
    if (e.target === this) {
        closeMessageModal();
    }
});

// Filter orders by status
function filterOrders(status) {
    const table = document.querySelector('table tbody');
    if (!table) return;
    
    const rows = table.getElementsByTagName('tr');
    const buttons = document.querySelectorAll('.filter-btn');
    
    // Update active button
    buttons.forEach(btn => btn.classList.remove('active'));
    event.target.closest('.filter-btn').classList.add('active');
    
    // Filter rows
    for (let row of rows) {
        const statusCell = row.querySelector('.status-badge');
        if (!statusCell) continue;
        
        const rowStatus = statusCell.textContent.trim().toLowerCase();
        
        if (status === 'all' || rowStatus === status) {
            row.style.display = '';
        } else {
            row.style.display = 'none';
        }
    }
    
    updateStats();
}

// Search orders
function searchOrders() {
    const input = document.getElementById('searchInput');
    const filter = input.value.toUpperCase();
    const table = document.querySelector('table tbody');
    
    if (!table) return;
    
    const rows = table.getElementsByTagName('tr');
    
    for (let row of rows) {
        const text = row.textContent || row.innerText;
        
        if (text.toUpperCase().indexOf(filter) > -1) {
            row.style.display = '';
        } else {
            row.style.display = 'none';
        }
    }
    
    updateStats();
}

// Update visible stats
function updateStats() {
    const table = document.querySelector('table tbody');
    if (!table) return;
    
    const rows = table.getElementsByTagName('tr');
    let visible = 0;
    
    for (let row of rows) {
        if (row.style.display !== 'none') {
            visible++;
        }
    }
    
    // Show message if no results
    const tableContainer = document.querySelector('.table-container');
    let noResults = document.getElementById('noResultsMessage');
    
    if (visible === 0) {
        if (!noResults) {
            noResults = document.createElement('div');
            noResults.id = 'noResultsMessage';
            noResults.className = 'empty-state';
            noResults.innerHTML = `
                <div class="empty-icon"><i class="fas fa-search"></i></div>
                <div class="empty-title">No Results Found</div>
                <div class="empty-text">Try adjusting your filters or search terms</div>
            `;
            tableContainer.appendChild(noResults);
        }
        document.querySelector('table').style.display = 'none';
    } else {
        document.querySelector('table').style.display = 'table';
        if (noResults) noResults.remove();
    }
}

// Clear on load
document.addEventListener('DOMContentLoaded', function() {
    const searchInput = document.getElementById('searchInput');
    if (searchInput) searchInput.value = '';
    
    // Load unread message count
    loadUnreadCount();
});

// Show all messages (message center)
function showAllMessages() {
    alert('Message Center - Coming Soon!\n\nThis will show all your messages across all orders.');
    // You can implement a full message center page later
    // For now, users can click the Message button on each order
}

// Load unread message count
function loadUnreadCount() {
    fetch('/distributor/unread_count')
        .then(response => response.json())
        .then(data => {
            const badge = document.getElementById('unreadBadge');
            if (data.count > 0) {
                badge.textContent = data.count;
                badge.style.display = 'block';
            } else {
                badge.style.display = 'none';
            }
        })
        .catch(error => {
            console.error('Error loading unread count:', error);
        });
}

// Refresh unread count every 30 seconds
setInterval(loadUnreadCount, 30000);
</script>
{% endblock %}