{% extends "distributor_base.html" %}

{% block title %}Manage Sales — Golden Bee{% endblock %}

{% block breadcrumb %}Sales{% endblock %}
{% block page_title %}Manage Sales{% endblock %}

{% block extra_css %}
<style>
  /* ── Page variables ── */
  :root {
    --gold:        #FDB022;
    --gold-light:  #FFF3CD;
    --gold-dark:   #E69A0E;
    --green:       #10B981;
    --green-light: #D1FAE5;
    --red:         #EF4444;
    --red-light:   #FEE2E2;
    --amber:       #F59E0B;
    --amber-light: #FEF3C7;
    --blue:        #3B82F6;
    --blue-light:  #DBEAFE;
    --gray-50:     #F9FAFB;
    --gray-100:    #F3F4F6;
    --gray-200:    #E5E7EB;
    --gray-600:    #4B5563;
    --gray-800:    #1F2937;
    --radius:      12px;
    --shadow-sm:   0 1px 3px rgba(0,0,0,.08);
    --shadow-md:   0 4px 12px rgba(0,0,0,.10);
    --shadow-lg:   0 8px 24px rgba(0,0,0,.12);
  }

  /* ── KPI Cards ── */
  .kpi-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 20px;
    margin-bottom: 28px;
  }
  .kpi-card {
    background: #fff;
    border-radius: var(--radius);
    padding: 24px;
    box-shadow: var(--shadow-sm);
    border-left: 4px solid var(--gold);
    display: flex;
    align-items: center;
    gap: 16px;
    transition: box-shadow .2s, transform .2s;
  }
  .kpi-card:hover { box-shadow: var(--shadow-md); transform: translateY(-2px); }
  .kpi-card.green { border-left-color: var(--green); }
  .kpi-card.blue  { border-left-color: var(--blue); }
  .kpi-card.amber { border-left-color: var(--amber); }

  .kpi-icon {
    width: 52px; height: 52px;
    border-radius: 12px;
    display: flex; align-items: center; justify-content: center;
    font-size: 22px; flex-shrink: 0;
  }
  .kpi-icon.gold  { background: var(--gold-light);  color: var(--gold-dark); }
  .kpi-icon.green { background: var(--green-light); color: var(--green); }
  .kpi-icon.blue  { background: var(--blue-light);  color: var(--blue); }
  .kpi-icon.amber { background: var(--amber-light); color: var(--amber); }

  .kpi-info { flex: 1; min-width: 0; }
  .kpi-value { font-size: 26px; font-weight: 700; color: var(--gray-800); line-height: 1; }
  .kpi-label { font-size: 12px; color: #6B7280; margin-top: 4px; font-weight: 500; }

  /* ── Filter Bar ── */
  .filter-card {
    background: #fff;
    border-radius: var(--radius);
    padding: 20px 24px;
    box-shadow: var(--shadow-sm);
    margin-bottom: 24px;
  }
  .filter-row {
    display: flex;
    flex-wrap: wrap;
    gap: 12px;
    align-items: flex-end;
  }
  .filter-group { display: flex; flex-direction: column; gap: 6px; }
  .filter-group label { font-size: 12px; font-weight: 600; color: var(--gray-600); }
  .filter-input, .filter-select {
    height: 40px;
    padding: 0 14px;
    border: 1.5px solid var(--gray-200);
    border-radius: 8px;
    font-size: 13px;
    color: var(--gray-800);
    background: var(--gray-50);
    outline: none;
    transition: border-color .2s, box-shadow .2s;
    min-width: 170px;
  }
  .filter-input:focus, .filter-select:focus {
    border-color: var(--gold);
    box-shadow: 0 0 0 3px rgba(253,176,34,.15);
    background: #fff;
  }
  .filter-input[type="date"] { min-width: 150px; }

  /* ── Buttons ── */
  .btn {
    display: inline-flex; align-items: center; gap: 8px;
    padding: 0 18px; height: 40px;
    border-radius: 8px; border: none; cursor: pointer;
    font-size: 13px; font-weight: 600;
    text-decoration: none; transition: all .2s;
  }
  .btn-primary { background: var(--gold); color: #1F2937; }
  .btn-primary:hover { background: var(--gold-dark); box-shadow: 0 0 16px rgba(253,176,34,.4); }
  .btn-outline { background: #fff; color: var(--gray-600); border: 1.5px solid var(--gray-200); }
  .btn-outline:hover { background: var(--gray-100); color: var(--gray-800); }
  .btn-sm { padding: 0 12px; height: 32px; font-size: 12px; }
  .btn-danger { background: var(--red-light); color: var(--red); }
  .btn-danger:hover { background: var(--red); color: #fff; }
  .btn-info  { background: var(--blue-light); color: var(--blue); }
  .btn-info:hover  { background: var(--blue);  color: #fff; }
  .btn-edit  { background: var(--gold-light); color: var(--gold-dark); }
  .btn-edit:hover  { background: var(--gold); color: #1F2937; }

  /* ── Table Card ── */
  .table-card {
    background: #fff;
    border-radius: var(--radius);
    box-shadow: var(--shadow-sm);
    overflow: hidden;
  }
  .table-header {
    padding: 20px 24px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    border-bottom: 1px solid var(--gray-200);
  }
  .table-title { font-size: 16px; font-weight: 700; color: var(--gray-800); }
  .table-count { font-size: 13px; color: #6B7280; }
  .table-wrapper { overflow-x: auto; }
  table { width: 100%; border-collapse: collapse; }
  thead th {
    background: var(--gray-50);
    padding: 12px 16px;
    text-align: left;
    font-size: 11px;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: .05em;
    color: #6B7280;
    border-bottom: 1px solid var(--gray-200);
    white-space: nowrap;
  }
  tbody tr { transition: background .15s; }
  tbody tr:hover { background: var(--gray-50); }
  tbody td {
    padding: 14px 16px;
    font-size: 13px;
    color: var(--gray-800);
    border-bottom: 1px solid #F9FAFB;
    vertical-align: middle;
  }
  tbody tr:last-child td { border-bottom: none; }

  /* ── Status Badge ── */
  .badge {
    display: inline-flex; align-items: center; gap: 5px;
    padding: 4px 10px; border-radius: 20px;
    font-size: 11px; font-weight: 600; white-space: nowrap;
  }
  .badge-completed { background: var(--green-light); color: var(--green); }
  .badge-pending   { background: var(--amber-light); color: var(--amber); }
  .badge-cancelled { background: var(--red-light);   color: var(--red);   }
  .badge::before {
    content: ''; width: 6px; height: 6px; border-radius: 50%;
    background: currentColor;
  }

  /* ── Product cell ── */
  .product-cell { display: flex; align-items: center; gap: 10px; }
  .product-avatar {
    width: 36px; height: 36px; border-radius: 8px;
    background: var(--gold-light); color: var(--gold-dark);
    display: flex; align-items: center; justify-content: center;
    font-size: 14px; font-weight: 700; flex-shrink: 0;
  }
  .product-name { font-weight: 600; color: var(--gray-800); }
  .product-meta { font-size: 11px; color: #6B7280; margin-top: 2px; }

  /* ── Actions ── */
  .action-group { display: flex; gap: 6px; }

  /* ── Empty State ── */
  .empty-state {
    text-align: center; padding: 60px 24px;
    color: #6B7280;
  }
  .empty-state i { font-size: 48px; color: var(--gray-200); margin-bottom: 16px; }
  .empty-state h3 { font-size: 16px; font-weight: 600; color: var(--gray-800); margin-bottom: 8px; }
  .empty-state p  { font-size: 14px; }

  /* ── Amount ── */
  .amount-positive { font-weight: 700; color: var(--green); }

  /* Confirm dialog overlay */
  .modal-overlay {
    display: none; position: fixed; inset: 0;
    background: rgba(0,0,0,.5); z-index: 2000;
    align-items: center; justify-content: center;
  }
  .modal-overlay.active { display: flex; }
  .modal-box {
    background: #fff; border-radius: 16px;
    padding: 32px; max-width: 420px; width: 90%;
    box-shadow: var(--shadow-lg); text-align: center;
  }
  .modal-box i { font-size: 48px; color: var(--red); margin-bottom: 16px; }
  .modal-box h3 { font-size: 18px; font-weight: 700; margin-bottom: 8px; }
  .modal-box p  { color: #6B7280; font-size: 14px; margin-bottom: 24px; }
  .modal-actions { display: flex; gap: 12px; justify-content: center; }

  @media (max-width: 768px) {
    .kpi-grid { grid-template-columns: 1fr 1fr; }
    .filter-row { flex-direction: column; }
    .filter-input, .filter-select { width: 100%; }
  }
</style>
{% endblock %}

{% block topbar_actions %}

{% endblock %}

{% block content %}

<!-- KPI Cards -->
<div class="kpi-grid">
  <div class="kpi-card">
    <div class="kpi-icon gold"><i class="fas fa-receipt"></i></div>
    <div class="kpi-info">
      <div class="kpi-value">{{ stats[0] }}</div>
      <div class="kpi-label">Total Sales</div>
    </div>
  </div>
  <div class="kpi-card green">
    <div class="kpi-icon green"><i class="fas fa-coins"></i></div>
    <div class="kpi-info">
      <div class="kpi-value">LKR {{ "{:,.0f}".format(stats[1]) }}</div>
      <div class="kpi-label">Total Revenue</div>
    </div>
  </div>
  <div class="kpi-card blue">
    <div class="kpi-icon blue"><i class="fas fa-boxes"></i></div>
    <div class="kpi-info">
      <div class="kpi-value">{{ stats[2] }}</div>
      <div class="kpi-label">Units Sold</div>
    </div>
  </div>
  <div class="kpi-card amber">
    <div class="kpi-icon amber"><i class="fas fa-check-circle"></i></div>
    <div class="kpi-info">
      <div class="kpi-value">{{ completed }}</div>
      <div class="kpi-label">Completed</div>
    </div>
  </div>
</div>

<!-- Filters -->
<div class="filter-card">
  <form method="GET" action="{{ url_for('distributor_sell_bp.manage_sales') }}">
    <div class="filter-row">
      <div class="filter-group" style="flex:1; min-width:200px;">
        <label>Search</label>
        <input class="filter-input" name="search" value="{{ search }}"
               placeholder="Product or customer name…">
      </div>
      <div class="filter-group">
        <label>Status</label>
        <select class="filter-select" name="status">
          <option value="">All Status</option>
          <option value="completed" {% if status == 'completed' %}selected{% endif %}>Completed</option>
          <option value="pending"   {% if status == 'pending'   %}selected{% endif %}>Pending</option>
          <option value="cancelled" {% if status == 'cancelled' %}selected{% endif %}>Cancelled</option>
        </select>
      </div>
      <div class="filter-group">
        <label>From Date</label>
        <input class="filter-input" type="date" name="date_from" value="{{ date_from }}">
      </div>
      <div class="filter-group">
        <label>To Date</label>
        <input class="filter-input" type="date" name="date_to" value="{{ date_to }}">
      </div>
      <div class="filter-group" style="flex-direction:row; gap:8px; align-items:flex-end;">
        <button type="submit" class="btn btn-primary">
          <i class="fas fa-search"></i> Filter
        </button>
        <a href="{{ url_for('distributor_sell_bp.manage_sales') }}" class="btn btn-outline">
          <i class="fas fa-times"></i> Clear
        </a>
      </div>
    </div>
  </form>
</div>

<!-- Sales Table -->
<div class="table-card">
  <div class="table-header">
    <div>
      <div class="table-title">Sales Records</div>
      <div class="table-count">{{ sales|length }} record(s) found</div>
    </div>
    <a href="{{ url_for('distributor_sell_bp.sell_product') }}" class="btn btn-primary">
      <i class="fas fa-plus"></i> New Sale
    </a>
  </div>

  <div class="table-wrapper">
    {% if sales %}
    <table>
      <thead>
        <tr>
          <th>#</th>
          <th>Product</th>
          <th>Customer</th>
          <th>Qty</th>
          <th>Unit Price</th>
          <th>Total</th>
          <th>Status</th>
          <th>Date</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody>
        {% for sale in sales %}
        <tr>
          <td style="color:#9CA3AF; font-size:12px;">{{ sale[0] }}</td>
          <td>
            <div class="product-cell">
              <div class="product-avatar">{{ sale[1][0].upper() }}</div>
              <div>
                <div class="product-name">{{ sale[1] }}</div>
                <div class="product-meta">{{ sale[10] or '' }} — {{ sale[11] or '' }}</div>
              </div>
            </div>
          </td>
          <td>
            <div style="font-weight:600;">{{ sale[5] or '—' }}</div>
            <div style="font-size:11px; color:#6B7280;">{{ sale[6] or '' }}</div>
          </td>
          <td><strong>{{ sale[2] }}</strong></td>
          <td>LKR {{ "{:,.2f}".format(sale[3]) }}</td>
          <td class="amount-positive">LKR {{ "{:,.2f}".format(sale[4]) }}</td>
          <td>
            <span class="badge badge-{{ sale[8] }}">{{ sale[8]|capitalize }}</span>
          </td>
          <td style="font-size:12px; color:#6B7280; white-space:nowrap;">
            {{ sale[7].strftime('%d %b %Y') if sale[7] else '—' }}
          </td>
          <td>
            <div class="action-group">
              <a href="{{ url_for('distributor_sell_bp.sale_detail', sale_id=sale[0]) }}"
                 class="btn btn-info btn-sm" title="View Details">
                <i class="fas fa-eye"></i>
              </a>
              <a href="{{ url_for('distributor_sell_bp.update_sale', sale_id=sale[0]) }}"
                 class="btn btn-edit btn-sm" title="Edit">
                <i class="fas fa-edit"></i>
              </a>
              <button class="btn btn-danger btn-sm btn-delete" title="Delete"
                      data-id="{{ sale[0] }}" data-name="{{ sale[1][:20] }}">
                <i class="fas fa-trash"></i>
              </button>
            </div>
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
    {% else %}
    <div class="empty-state">
      <i class="fas fa-receipt"></i>
      <h3>No sales found</h3>
      <p>Try adjusting your filters or record a new sale.</p>
      <a href="{{ url_for('distributor_sell_bp.sell_product') }}" class="btn btn-primary" style="margin-top:16px;">
        <i class="fas fa-plus"></i> Record Sale
      </a>
    </div>
    {% endif %}
  </div>
</div>

<!-- Delete Confirm Modal -->
<div class="modal-overlay" id="deleteModal">
  <div class="modal-box">
    <i class="fas fa-exclamation-triangle"></i>
    <h3>Delete Sale?</h3>
    <p id="deleteModalMsg">This action will restore the stock quantity. This cannot be undone.</p>
    <div class="modal-actions">
      <button class="btn btn-outline" onclick="closeModal()">Cancel</button>
      <form id="deleteForm" method="POST">
        <input type="hidden" name="_method" value="DELETE">
        <button type="submit" class="btn btn-danger">Delete Sale</button>
      </form>
    </div>
  </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
// Use event delegation — avoids Jinja2/JS inline onclick conflicts
document.addEventListener('click', function(e) {
  const btn = e.target.closest('.btn-delete');
  if (btn) {
    const saleId   = btn.dataset.id;
    const prodName = btn.dataset.name;
    document.getElementById('deleteModalMsg').textContent =
      `Delete sale of "${prodName}"? Stock will be restored.`;
    document.getElementById('deleteForm').action =
      `/distributor/delete_sale/${saleId}`;
    document.getElementById('deleteModal').classList.add('active');
  }
});

function closeModal() {
  document.getElementById('deleteModal').classList.remove('active');
}
document.getElementById('deleteModal').addEventListener('click', function(e) {
  if (e.target === this) closeModal();
});
</script>
{% endblock %}